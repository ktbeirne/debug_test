name: Error Analysis with Claude Code

on:
  repository_dispatch:
    types: [error-detected]
  workflow_dispatch:
    inputs:
      error_message:
        description: 'Error message for testing'
        required: false
        default: 'Manual test error'
      error_type:
        description: 'Error type'
        required: false
        default: 'TestError'

jobs:
  analyze-error:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract error information
        id: error-info
        run: |
          echo "error_message=${{ github.event.client_payload.error_message }}" >> $GITHUB_OUTPUT
          echo "error_type=${{ github.event.client_payload.error_type }}" >> $GITHUB_OUTPUT
          echo "timestamp=${{ github.event.client_payload.timestamp }}" >> $GITHUB_OUTPUT
          echo "log_group=${{ github.event.client_payload.log_group }}" >> $GITHUB_OUTPUT
          echo "context=${{ github.event.client_payload.context }}" >> $GITHUB_OUTPUT

      - name: Create error analysis prompt
        id: create-prompt
        run: |
          cat << 'EOF' > error_analysis_prompt.md
          # ã‚¨ãƒ©ãƒ¼è§£æä¾é ¼

          ä»¥ä¸‹ï¿½Eã‚¨ãƒ©ãƒ¼ãŒæœ¬ç•ªç’°å¢Eï¿½ï¿½ç™ºç”Ÿã—ã¾ã—ãŸã€‚ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’è§£æã—ã¦ã€æ ¹æœ¬åŸå› ã¨ä¿®æ­£æ–¹æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€E

          ## ã‚¨ãƒ©ãƒ¼æƒEï¿½ï¿½

          - **ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒE*: ${{ github.event.client_payload.error_type }}
          - **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒEï¿½ï¿½ãƒ¼ã‚¸**: ${{ github.event.client_payload.error_message }}
          - **ç™ºç”Ÿæ™‚åˆ»**: ${{ github.event.client_payload.timestamp }}
          - **ã‚³ãƒ³ãƒEï¿½ï¿½ã‚¹ãƒE*: ${{ github.event.client_payload.context }}
          - **ãƒ­ã‚°ã‚½ãƒ¼ã‚¹**: ${{ github.event.client_payload.log_group }}

          ## ã‚¹ã‚¿ãƒEï¿½ï¿½ãƒˆãƒ¬ãƒ¼ã‚¹

          ```
          ${{ github.event.client_payload.error_stack }}
          ```

          ## è§£æã—ã¦ã»ã—ã„å†Eï¿½ï¿½

          1. **æ ¹æœ¬åŸå› **: ã“ï¿½Eã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ ¹æœ¬çšEï¿½ï¿½åŸå› ã¯ä½•ã‹ï¿½Eï¿½E
          2. **å½±éŸ¿ç¯Eï¿½ï¿½**: ã“ï¿½Eã‚¨ãƒ©ãƒ¼ã¯ã©ã®æ©Ÿï¿½Eã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã‹ï¿½Eï¿½E
          3. **ä¿®æ­£æ–¹æ³E*: ã©ã®ã‚ˆã†ã«ä¿®æ­£ã™ã¹ãã‹ï¿½Eï¿½ï¿½Eä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ææ¡ˆã—ã¦ãã ã•ã„
          4. **å†ç™ºé˜²æ­¢**: åŒæ§˜ï¿½Eã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã«ã€ã©ã®ã‚ˆã†ãªå¯¾ç­–ãŒå¿Eï¿½ï¿½ã‹ï¿½Eï¿½E

          ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã€è©³ç´°ãªè§£æãƒ¬ãƒï¿½Eãƒˆã‚’ä½œï¿½Eã—ã¦ãã ã•ã„ã€E
          EOF

          cat error_analysis_prompt.md

      - name: Create Issue with error details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errorStack = `${{ github.event.client_payload.error_stack }}`;
            const errorMessage = `${{ github.event.client_payload.error_message }}`;
            const errorType = `${{ github.event.client_payload.error_type }}`;
            const timestamp = `${{ github.event.client_payload.timestamp }}`;
            const errorContext = `${{ github.event.client_payload.context }}`;
            const logGroup = `${{ github.event.client_payload.log_group }}`;

            const issueBody = `
            ## ğŸš¨ ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥é€šçŸ¥

            æœ¬ç•ªç’°å¢Eï¿½ï¿½ã‚¨ãƒ©ãƒ¼ãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸã€Elaude Codeã«ã‚ˆã‚‹è‡ªå‹•è§£æã‚’å®Ÿæ–½ã—ã¾ã™ã€E

            ### ã‚¨ãƒ©ãƒ¼æƒEï¿½ï¿½

            | é Eï¿½ï¿½ | å†Eï¿½ï¿½ |
            |------|------|
            | **ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒE* | \`${errorType}\` |
            | **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒEï¿½ï¿½ãƒ¼ã‚¸** | ${errorMessage} |
            | **ç™ºç”Ÿæ™‚åˆ»** | ${timestamp} |
            | **ã‚³ãƒ³ãƒEï¿½ï¿½ã‚¹ãƒE* | ${errorContext} |
            | **ãƒ­ã‚°ã‚½ãƒ¼ã‚¹** | ${logGroup} |

            ### ã‚¹ã‚¿ãƒEï¿½ï¿½ãƒˆãƒ¬ãƒ¼ã‚¹

            \`\`\`
            ${errorStack}
            \`\`\`

            ---

            ### ğŸ“‹ è§£æä¾é ¼

            @claude-code ä¸Šè¨˜ï¿½Eã‚¨ãƒ©ãƒ¼ã«ã¤ãEï¿½ï¿½ã€ä»¥ä¸‹ï¿½Eè¦³ç‚¹ã§è§£æã—ã¦ãã ã•ã„:

            1. **æ ¹æœ¬åŸå› **: ã“ï¿½Eã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ ¹æœ¬çšEï¿½ï¿½åŸå› 
            2. **å½±éŸ¿ç¯Eï¿½ï¿½**: ã“ï¿½Eã‚¨ãƒ©ãƒ¼ãŒå½±éŸ¿ã™ã‚‹æ©Ÿï¿½Eã‚Eï¿½ï¿½Eï¿½ï¿½
            3. **ä¿®æ­£æ–¹æ³E*: å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ææ¡E
            4. **å†ç™ºé˜²æ­¢**: åŒæ§˜ï¿½Eã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ï¿½Eå¯¾ç­E

            ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã€è©³ç´°ãªè§£æãƒ¬ãƒï¿½Eãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€E
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[è‡ªå‹•æ¤œçŸ¥] ${errorType}: ${errorMessage}`,
              body: issueBody,
              labels: ['bug', 'auto-detected', 'needs-analysis']
            });

            console.log(`Issue created: ${issue.data.html_url}`);
