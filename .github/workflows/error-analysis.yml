name: Error Analysis with Claude Code (Automation Mode)

on:
  repository_dispatch:
    types: [error-detected]
  workflow_dispatch:
    inputs:
      error_message:
        description: 'Error message for testing'
        required: false
        default: 'Manual test error'
      error_type:
        description: 'Error type'
        required: false
        default: 'TestError'

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  analyze-error:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Action (Automation Mode)
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            # エラー自動解析タスク

            本番環境でエラーが検知されました。以下の情報を元に、適切に対処してください。

            ## エラー情報

            - **エラータイプ**: ${{ github.event.client_payload.error_type }}
            - **エラーメッセージ**: ${{ github.event.client_payload.error_message }}
            - **発生時刻**: ${{ github.event.client_payload.timestamp }}
            - **コンテキスト**: ${{ github.event.client_payload.context }}
            - **ログソース**: ${{ github.event.client_payload.log_group }}

            ### スタックトレース
            ```
            ${{ github.event.client_payload.error_stack }}
            ```

            ## あなたのタスク

            1. **既存Issueの重複チェック**
               - 現在オープンしているIssueを確認し、同じエラーや根本原因が同じIssueが既に存在しないかチェック
               - 存在する場合は、そのIssueにコメントを追加して終了
               - 存在しない場合は、次のステップへ

            2. **コード解析**
               - リポジトリのコードを確認し、エラーの根本原因を特定
               - `src/lambda/sample-app/index.ts` を中心に調査

            3. **Issue作成**（重複がない場合のみ）
               - 以下の形式で分かりやすいタイトルを付けてIssueを作成：
                 例: 「削除済み記事取得時のnullポインタエラー」
                 例: 「JSONパース失敗時のエラーハンドリング不足」
               - ラベル: `bug`, `auto-detected`, `needs-fix`

            4. **解析レポート作成**
               - Issue本文に以下の内容を含める：
                 - **概要**: エラーの簡潔な説明
                 - **根本原因**: コードのどの部分に問題があるか（ファイル名:行番号）
                 - **影響範囲**: このエラーが影響する機能やユーザー
                 - **修正方法**: 具体的なコード変更の提案
                 - **再発防止**: 同様のエラーを防ぐための対策
                 - **検知情報**: 上記のエラー情報とスタックトレース

            ## 重要な注意点

            - 同じ根本原因のエラーで複数のIssueを作らない
            - Issue名は人間が理解しやすい日本語で
            - コードの該当箇所は `file_path:line_number` 形式で明記
