name: Error Analysis with Claude Code

on:
  repository_dispatch:
    types: [error-detected]

jobs:
  analyze-error:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract error information
        id: error-info
        run: |
          echo "error_message=${{ github.event.client_payload.error_message }}" >> $GITHUB_OUTPUT
          echo "error_type=${{ github.event.client_payload.error_type }}" >> $GITHUB_OUTPUT
          echo "timestamp=${{ github.event.client_payload.timestamp }}" >> $GITHUB_OUTPUT
          echo "log_group=${{ github.event.client_payload.log_group }}" >> $GITHUB_OUTPUT
          echo "context=${{ github.event.client_payload.context }}" >> $GITHUB_OUTPUT

      - name: Create error analysis prompt
        id: create-prompt
        run: |
          cat << 'EOF' > error_analysis_prompt.md
          # ã‚¨ãƒ©ãƒ¼è§£æä¾é ¼

          ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒæœ¬ç•ªç’°å¢ƒã§ç™ºç”Ÿã—ã¾ã—ãŸã€‚ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’è§£æã—ã¦ã€æ ¹æœ¬åŸå› ã¨ä¿®æ­£æ–¹æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

          ## ã‚¨ãƒ©ãƒ¼æƒ…å ±

          - **ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—**: ${{ github.event.client_payload.error_type }}
          - **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${{ github.event.client_payload.error_message }}
          - **ç™ºç”Ÿæ™‚åˆ»**: ${{ github.event.client_payload.timestamp }}
          - **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**: ${{ github.event.client_payload.context }}
          - **ãƒ­ã‚°ã‚½ãƒ¼ã‚¹**: ${{ github.event.client_payload.log_group }}

          ## ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹

          ```
          ${{ github.event.client_payload.error_stack }}
          ```

          ## è§£æã—ã¦ã»ã—ã„å†…å®¹

          1. **æ ¹æœ¬åŸå› **: ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ ¹æœ¬çš„ãªåŸå› ã¯ä½•ã‹ï¼Ÿ
          2. **å½±éŸ¿ç¯„å›²**: ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ã©ã®æ©Ÿèƒ½ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã‹ï¼Ÿ
          3. **ä¿®æ­£æ–¹æ³•**: ã©ã®ã‚ˆã†ã«ä¿®æ­£ã™ã¹ãã‹ï¼Ÿå…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ææ¡ˆã—ã¦ãã ã•ã„
          4. **å†ç™ºé˜²æ­¢**: åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã«ã€ã©ã®ã‚ˆã†ãªå¯¾ç­–ãŒå¿…è¦ã‹ï¼Ÿ

          ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã€è©³ç´°ãªè§£æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          EOF

          cat error_analysis_prompt.md

      - name: Create Issue with error details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errorStack = `${{ github.event.client_payload.error_stack }}`;
            const errorMessage = `${{ github.event.client_payload.error_message }}`;
            const errorType = `${{ github.event.client_payload.error_type }}`;
            const timestamp = `${{ github.event.client_payload.timestamp }}`;
            const context = `${{ github.event.client_payload.context }}`;
            const logGroup = `${{ github.event.client_payload.log_group }}`;

            const issueBody = `
            ## ğŸš¨ ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥é€šçŸ¥

            æœ¬ç•ªç’°å¢ƒã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸã€‚Claude Codeã«ã‚ˆã‚‹è‡ªå‹•è§£æã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

            ### ã‚¨ãƒ©ãƒ¼æƒ…å ±

            | é …ç›® | å†…å®¹ |
            |------|------|
            | **ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—** | \`${errorType}\` |
            | **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** | ${errorMessage} |
            | **ç™ºç”Ÿæ™‚åˆ»** | ${timestamp} |
            | **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ** | ${errorContext} |
            | **ãƒ­ã‚°ã‚½ãƒ¼ã‚¹** | ${logGroup} |

            ### ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹

            \`\`\`
            ${errorStack}
            \`\`\`

            ---

            ### ğŸ“‹ è§£æä¾é ¼

            @claude-code ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§è§£æã—ã¦ãã ã•ã„:

            1. **æ ¹æœ¬åŸå› **: ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ ¹æœ¬çš„ãªåŸå› 
            2. **å½±éŸ¿ç¯„å›²**: ã“ã®ã‚¨ãƒ©ãƒ¼ãŒå½±éŸ¿ã™ã‚‹æ©Ÿèƒ½ã‚„ç¯„å›²
            3. **ä¿®æ­£æ–¹æ³•**: å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ææ¡ˆ
            4. **å†ç™ºé˜²æ­¢**: åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã®å¯¾ç­–

            ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã€è©³ç´°ãªè§£æãƒ¬ãƒãƒ¼ãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[è‡ªå‹•æ¤œçŸ¥] ${errorType}: ${errorMessage}`,
              body: issueBody,
              labels: ['bug', 'auto-detected', 'needs-analysis']
            });

            console.log(`Issue created: ${issue.data.html_url}`);
