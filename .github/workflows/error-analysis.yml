name: Error Analysis with Claude Code (Automation Mode)

on:
  repository_dispatch:
    types: [error-detected]
  workflow_dispatch:
    inputs:
      error_message:
        description: 'Error message for testing'
        required: false
        default: 'Manual test error'
      error_type:
        description: 'Error type'
        required: false
        default: 'TestError'

permissions:
  issues: write
  contents: read
  pull-requests: write
  id-token: write

jobs:
  analyze-error:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Action (Automation Mode)
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          claude_args: |
            --allowedTools "Bash(gh:*),Read,Glob,Grep,TodoWrite"
            --max-turns 15

          prompt: |
            # ã‚¨ãƒ©ãƒ¼è‡ªå‹•è§£æã‚¿ã‚¹ã‚¯

            æœ¬ç•ªç’°å¢ƒã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’å…ƒã«ã€ã‚³ãƒ¼ãƒ‰è§£æã¨Issueä½œæˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

            ## ã‚¨ãƒ©ãƒ¼æƒ…å ±

            - **ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—**: ${{ github.event.client_payload.error_type }}
            - **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${{ github.event.client_payload.error_message }}
            - **ç™ºç”Ÿæ™‚åˆ»**: ${{ github.event.client_payload.timestamp }}
            - **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**: ${{ github.event.client_payload.context }}
            - **ãƒ­ã‚°ã‚½ãƒ¼ã‚¹**: ${{ github.event.client_payload.log_group }}

            ### ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
            ```
            ${{ github.event.client_payload.error_stack }}
            ```

            ## ã‚ãªãŸã®ã‚¿ã‚¹ã‚¯

            1. **æ—¢å­˜Issueã®é‡è¤‡ãƒã‚§ãƒƒã‚¯**
               - `gh issue list --state open --json number,title,body --limit 50` ã§ç¾åœ¨ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ã„ã‚‹Issueã‚’ç¢ºèª
               - åŒã˜ã‚¨ãƒ©ãƒ¼ã‚„æ ¹æœ¬åŸå› ãŒåŒã˜IssueãŒæ—¢ã«å­˜åœ¨ã—ãªã„ã‹ãƒã‚§ãƒƒã‚¯
               - å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ãã®Issueã«çŠ¶æ³ã‚’è¿½è¨˜ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦çµ‚äº†
               - å­˜åœ¨ã—ãªã„å ´åˆã¯ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸

            2. **ã‚³ãƒ¼ãƒ‰è§£æ**
               - ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ï¼ˆç‰¹ã« `src/lambda/sample-app/index.ts`ï¼‰ã‚’ç¢ºèª
               - ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®š
               - å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ç®‡æ‰€ã‚’ç‰¹å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·ï¼‰

            3. **Issueä½œæˆ**ï¼ˆé‡è¤‡ãŒãªã„å ´åˆã®ã¿ï¼‰
               - ä»¥ä¸‹ã®å½¢å¼ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä»˜ã‘ã¦Issueã‚’ä½œæˆï¼š
                 - è‰¯ã„ä¾‹: ã€Œå‰Šé™¤æ¸ˆã¿è¨˜äº‹å–å¾—æ™‚ã®nullãƒã‚¤ãƒ³ã‚¿ã‚¨ãƒ©ãƒ¼ (GET /articles/:id)ã€
                 - è‰¯ã„ä¾‹: ã€ŒJSONãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¸è¶³ (POST /articles)ã€
                 - æ‚ªã„ä¾‹: ã€Œã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€ã€ŒTypeErrorã€
               - Issueåã«ã¯ç™ºç”Ÿå ´æ‰€ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚„é–¢æ•°åï¼‰ã‚’å«ã‚ã‚‹
               - ãƒ©ãƒ™ãƒ«: `bug`, `auto-detected`, `needs-fix`

            3. **è§£æãƒ¬ãƒãƒ¼ãƒˆä½œæˆ**

               Issueæœ¬æ–‡ã«ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å«ã‚ã¦ãã ã•ã„ï¼š

               ### ğŸ”´ ã‚¨ãƒ©ãƒ¼æ¦‚è¦
               ï¼ˆã‚¨ãƒ©ãƒ¼ã®ç°¡æ½”ãªèª¬æ˜ã‚’1-2æ–‡ã§ï¼‰

               ### ğŸ” æ ¹æœ¬åŸå› 
               - **å•é¡Œç®‡æ‰€**: `ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·`
               - **åŸå› **: ï¼ˆãªãœã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ï¼‰
               - **ã‚³ãƒ¼ãƒ‰ã®å•é¡Œ**: ï¼ˆè©²å½“ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼‰

               ### ğŸ“Š å½±éŸ¿ç¯„å›²
               - **å½±éŸ¿ã‚’å—ã‘ã‚‹æ©Ÿèƒ½**:
               - **å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼**:
               - **æ·±åˆ»åº¦**: ï¼ˆCritical/High/Medium/Lowï¼‰

               ### ğŸ› ï¸ ä¿®æ­£æ–¹æ³•
               ï¼ˆå…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ææ¡ˆã‚’ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ï¼‰

               ### ğŸš€ å†ç™ºé˜²æ­¢ç­–
               - ï¼ˆåŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã®å¯¾ç­–ï¼‰

               ### ğŸ“ æ¤œçŸ¥æƒ…å ±
               ```
               ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${{ github.event.client_payload.error_type }}
               ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ github.event.client_payload.error_message }}
               ç™ºç”Ÿæ™‚åˆ»: ${{ github.event.client_payload.timestamp }}
               ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ${{ github.event.client_payload.context }}
               ãƒ­ã‚°ã‚½ãƒ¼ã‚¹: ${{ github.event.client_payload.log_group }}
               ```

               <details>
               <summary>ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹</summary>

               ```
               ${{ github.event.client_payload.error_stack }}
               ```
               </details>

            ## é‡è¦ãªæ³¨æ„ç‚¹

            - **gh CLIã‚³ãƒãƒ³ãƒ‰ã¯è‡ªå‹•æ‰¿èªã•ã‚Œã¾ã™** - ç©æ¥µçš„ã«ä½¿ç”¨ã—ã¦é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ã¦ãã ã•ã„
            - åŒã˜æ ¹æœ¬åŸå› ã®ã‚¨ãƒ©ãƒ¼ã§è¤‡æ•°ã®Issueã‚’ä½œã‚‰ãªã„ã§ãã ã•ã„
            - Issueåã¯äººé–“ãŒç†è§£ã—ã‚„ã™ã„æ—¥æœ¬èªã§ã€ç™ºç”Ÿå ´æ‰€ã‚’å«ã‚ã¦ãã ã•ã„
            - ã‚³ãƒ¼ãƒ‰ã®è©²å½“ç®‡æ‰€ã¯å¿…ãš `file_path:line_number` å½¢å¼ã§æ˜è¨˜ã—ã¦ãã ã•ã„
            - ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› ã‚’ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç‰¹å®šã—ã€å…·ä½“çš„ãªä¿®æ­£æ¡ˆã‚’æç¤ºã—ã¦ãã ã•ã„
            - æ—¢å­˜Issueã«è¿½è¨˜ã™ã‚‹å ´åˆã¯ `gh issue comment <ç•ªå·> --body "å†…å®¹"` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
