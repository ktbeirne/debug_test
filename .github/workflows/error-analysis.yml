name: Error Analysis with Claude Code

on:
  repository_dispatch:
    types: [error-detected]

jobs:
  analyze-error:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract error information
        id: error-info
        run: |
          echo "error_message=${{ github.event.client_payload.error_message }}" >> $GITHUB_OUTPUT
          echo "error_type=${{ github.event.client_payload.error_type }}" >> $GITHUB_OUTPUT
          echo "timestamp=${{ github.event.client_payload.timestamp }}" >> $GITHUB_OUTPUT
          echo "log_group=${{ github.event.client_payload.log_group }}" >> $GITHUB_OUTPUT
          echo "context=${{ github.event.client_payload.context }}" >> $GITHUB_OUTPUT

      - name: Create error analysis prompt
        id: create-prompt
        run: |
          cat << 'EOF' > error_analysis_prompt.md
          # 繧ｨ繝ｩ繝ｼ隗｣譫蝉ｾ晞ｼ

          莉･荳九・繧ｨ繝ｩ繝ｼ縺梧悽逡ｪ迺ｰ蠅・〒逋ｺ逕溘＠縺ｾ縺励◆縲ゅ％縺ｮ繝ｪ繝昴ず繝医Μ縺ｮ繧ｳ繝ｼ繝峨ｒ隗｣譫舌＠縺ｦ縲∵ｹ譛ｬ蜴溷屏縺ｨ菫ｮ豁｣譁ｹ豕輔ｒ謠先｡医＠縺ｦ縺上□縺輔＞縲・

          ## 繧ｨ繝ｩ繝ｼ諠・ｱ

          - **繧ｨ繝ｩ繝ｼ繧ｿ繧､繝・*: ${{ github.event.client_payload.error_type }}
          - **繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ**: ${{ github.event.client_payload.error_message }}
          - **逋ｺ逕滓凾蛻ｻ**: ${{ github.event.client_payload.timestamp }}
          - **繧ｳ繝ｳ繝・く繧ｹ繝・*: ${{ github.event.client_payload.context }}
          - **繝ｭ繧ｰ繧ｽ繝ｼ繧ｹ**: ${{ github.event.client_payload.log_group }}

          ## 繧ｹ繧ｿ繝・け繝医Ξ繝ｼ繧ｹ

          ```
          ${{ github.event.client_payload.error_stack }}
          ```

          ## 隗｣譫舌＠縺ｦ縺ｻ縺励＞蜀・ｮｹ

          1. **譬ｹ譛ｬ蜴溷屏**: 縺薙・繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺滓ｹ譛ｬ逧・↑蜴溷屏縺ｯ菴輔°・・
          2. **蠖ｱ髻ｿ遽・峇**: 縺薙・繧ｨ繝ｩ繝ｼ縺ｯ縺ｩ縺ｮ讖溯・縺ｫ蠖ｱ髻ｿ繧剃ｸ弱∴繧九°・・
          3. **菫ｮ豁｣譁ｹ豕・*: 縺ｩ縺ｮ繧医≧縺ｫ菫ｮ豁｣縺吶∋縺阪°・溷・菴鍋噪縺ｪ繧ｳ繝ｼ繝牙､画峩繧呈署譯医＠縺ｦ縺上□縺輔＞
          4. **蜀咲匱髦ｲ豁｢**: 蜷梧ｧ倥・繧ｨ繝ｩ繝ｼ繧帝亟縺舌◆繧√↓縲√←縺ｮ繧医≧縺ｪ蟇ｾ遲悶′蠢・ｦ√°・・

          繝ｪ繝昴ず繝医Μ縺ｮ繧ｳ繝ｼ繝峨ｒ遒ｺ隱阪＠縺ｦ縲∬ｩｳ邏ｰ縺ｪ隗｣譫舌Ξ繝昴・繝医ｒ菴懈・縺励※縺上□縺輔＞縲・
          EOF

          cat error_analysis_prompt.md

      - name: Create Issue with error details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errorStack = `${{ github.event.client_payload.error_stack }}`;
            const errorMessage = `${{ github.event.client_payload.error_message }}`;
            const errorType = `${{ github.event.client_payload.error_type }}`;
            const timestamp = `${{ github.event.client_payload.timestamp }}`;
            const errorContext = `${{ github.event.client_payload.context }}`;
            const logGroup = `${{ github.event.client_payload.log_group }}`;

            const issueBody = `
            ## 圷 繧ｨ繝ｩ繝ｼ讀懃衍騾夂衍

            譛ｬ逡ｪ迺ｰ蠅・〒繧ｨ繝ｩ繝ｼ縺梧､懃衍縺輔ｌ縺ｾ縺励◆縲・laude Code縺ｫ繧医ｋ閾ｪ蜍戊ｧ｣譫舌ｒ螳滓命縺励∪縺吶・

            ### 繧ｨ繝ｩ繝ｼ諠・ｱ

            | 鬆・岼 | 蜀・ｮｹ |
            |------|------|
            | **繧ｨ繝ｩ繝ｼ繧ｿ繧､繝・* | \`${errorType}\` |
            | **繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ** | ${errorMessage} |
            | **逋ｺ逕滓凾蛻ｻ** | ${timestamp} |
            | **繧ｳ繝ｳ繝・く繧ｹ繝・* | ${errorContext} |
            | **繝ｭ繧ｰ繧ｽ繝ｼ繧ｹ** | ${logGroup} |

            ### 繧ｹ繧ｿ繝・け繝医Ξ繝ｼ繧ｹ

            \`\`\`
            ${errorStack}
            \`\`\`

            ---

            ### 搭 隗｣譫蝉ｾ晞ｼ

            @claude-code 荳願ｨ倥・繧ｨ繝ｩ繝ｼ縺ｫ縺､縺・※縲∽ｻ･荳九・隕ｳ轤ｹ縺ｧ隗｣譫舌＠縺ｦ縺上□縺輔＞:

            1. **譬ｹ譛ｬ蜴溷屏**: 縺薙・繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺滓ｹ譛ｬ逧・↑蜴溷屏
            2. **蠖ｱ髻ｿ遽・峇**: 縺薙・繧ｨ繝ｩ繝ｼ縺悟ｽｱ髻ｿ縺吶ｋ讖溯・繧・ｯ・峇
            3. **菫ｮ豁｣譁ｹ豕・*: 蜈ｷ菴鍋噪縺ｪ繧ｳ繝ｼ繝牙､画峩縺ｮ謠先｡・
            4. **蜀咲匱髦ｲ豁｢**: 蜷梧ｧ倥・繧ｨ繝ｩ繝ｼ繧帝亟縺舌◆繧√・蟇ｾ遲・

            繝ｪ繝昴ず繝医Μ縺ｮ繧ｳ繝ｼ繝峨ｒ遒ｺ隱阪＠縺ｦ縲∬ｩｳ邏ｰ縺ｪ隗｣譫舌Ξ繝昴・繝医ｒ縺企｡倥＞縺励∪縺吶・
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[閾ｪ蜍墓､懃衍] ${errorType}: ${errorMessage}`,
              body: issueBody,
              labels: ['bug', 'auto-detected', 'needs-analysis']
            });

            console.log(`Issue created: ${issue.data.html_url}`);
